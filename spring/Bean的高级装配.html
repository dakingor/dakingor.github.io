<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bean的高级装配 | 大坚博客</title>
    <meta name="description" content="现在还远远没有达到需要拼智商的地步">
    <link rel="icon" href="/img/favicon.ico">
    
    <link rel="preload" href="/assets/css/styles.bb1fe17d.css" as="style"><link rel="preload" href="/assets/js/app.bb1fe17d.js" as="script"><link rel="preload" href="/assets/js/86.513e36a1.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.b05fc641.css"><link rel="prefetch" href="/assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="/assets/js/1.b05fc641.js"><link rel="prefetch" href="/assets/js/10.326ff491.js"><link rel="prefetch" href="/assets/js/11.9241fc7b.js"><link rel="prefetch" href="/assets/js/12.7acf36a5.js"><link rel="prefetch" href="/assets/js/13.ec549dd5.js"><link rel="prefetch" href="/assets/js/14.28942eba.js"><link rel="prefetch" href="/assets/js/15.e903c1ca.js"><link rel="prefetch" href="/assets/js/16.4d7ab5b5.js"><link rel="prefetch" href="/assets/js/17.36afdc36.js"><link rel="prefetch" href="/assets/js/18.cac2535e.js"><link rel="prefetch" href="/assets/js/19.cd2f75e9.js"><link rel="prefetch" href="/assets/js/2.a2bd3099.js"><link rel="prefetch" href="/assets/js/20.bf313935.js"><link rel="prefetch" href="/assets/js/21.31b36d89.js"><link rel="prefetch" href="/assets/js/22.0361f270.js"><link rel="prefetch" href="/assets/js/23.1b3f1574.js"><link rel="prefetch" href="/assets/js/24.4d491f2a.js"><link rel="prefetch" href="/assets/js/25.52f1876f.js"><link rel="prefetch" href="/assets/js/26.e08e41e4.js"><link rel="prefetch" href="/assets/js/27.4bbac78e.js"><link rel="prefetch" href="/assets/js/28.b5bd620c.js"><link rel="prefetch" href="/assets/js/29.84b65be3.js"><link rel="prefetch" href="/assets/js/3.c091e437.js"><link rel="prefetch" href="/assets/js/30.fe84dfad.js"><link rel="prefetch" href="/assets/js/31.166d5bc3.js"><link rel="prefetch" href="/assets/js/32.d65d9239.js"><link rel="prefetch" href="/assets/js/33.583bc596.js"><link rel="prefetch" href="/assets/js/34.6b83f133.js"><link rel="prefetch" href="/assets/js/35.49d1569f.js"><link rel="prefetch" href="/assets/js/36.0446fb7e.js"><link rel="prefetch" href="/assets/js/37.5fbd12a4.js"><link rel="prefetch" href="/assets/js/38.1b808891.js"><link rel="prefetch" href="/assets/js/39.3b1c557a.js"><link rel="prefetch" href="/assets/js/4.fb6903e4.js"><link rel="prefetch" href="/assets/js/40.ac5b164f.js"><link rel="prefetch" href="/assets/js/41.45b078e5.js"><link rel="prefetch" href="/assets/js/42.d40844bf.js"><link rel="prefetch" href="/assets/js/43.9009d6e3.js"><link rel="prefetch" href="/assets/js/44.1e61fc92.js"><link rel="prefetch" href="/assets/js/45.9424e6d8.js"><link rel="prefetch" href="/assets/js/46.efbee1cd.js"><link rel="prefetch" href="/assets/js/47.cee8ae47.js"><link rel="prefetch" href="/assets/js/48.3d5e7cb5.js"><link rel="prefetch" href="/assets/js/49.22238313.js"><link rel="prefetch" href="/assets/js/5.8891e232.js"><link rel="prefetch" href="/assets/js/50.4affbe35.js"><link rel="prefetch" href="/assets/js/51.fdb6ae2c.js"><link rel="prefetch" href="/assets/js/52.30127554.js"><link rel="prefetch" href="/assets/js/53.0dacde79.js"><link rel="prefetch" href="/assets/js/54.e2815542.js"><link rel="prefetch" href="/assets/js/55.83d95da2.js"><link rel="prefetch" href="/assets/js/56.fd6cfa75.js"><link rel="prefetch" href="/assets/js/57.64041257.js"><link rel="prefetch" href="/assets/js/58.feb49a9c.js"><link rel="prefetch" href="/assets/js/59.dc8df387.js"><link rel="prefetch" href="/assets/js/6.d54c1117.js"><link rel="prefetch" href="/assets/js/60.631c04b3.js"><link rel="prefetch" href="/assets/js/61.32aea37e.js"><link rel="prefetch" href="/assets/js/62.5cfec479.js"><link rel="prefetch" href="/assets/js/63.1433dd8f.js"><link rel="prefetch" href="/assets/js/64.ad33ff3d.js"><link rel="prefetch" href="/assets/js/65.701a8222.js"><link rel="prefetch" href="/assets/js/66.24bd90de.js"><link rel="prefetch" href="/assets/js/67.d396f2ec.js"><link rel="prefetch" href="/assets/js/68.2afd7019.js"><link rel="prefetch" href="/assets/js/69.05781e5f.js"><link rel="prefetch" href="/assets/js/7.1b94b949.js"><link rel="prefetch" href="/assets/js/70.2cf85943.js"><link rel="prefetch" href="/assets/js/71.aab07104.js"><link rel="prefetch" href="/assets/js/72.1533ead8.js"><link rel="prefetch" href="/assets/js/73.4e5dc4da.js"><link rel="prefetch" href="/assets/js/74.e77dfcb1.js"><link rel="prefetch" href="/assets/js/75.e8e4c83e.js"><link rel="prefetch" href="/assets/js/76.ce341a40.js"><link rel="prefetch" href="/assets/js/77.c2342e89.js"><link rel="prefetch" href="/assets/js/78.a56458f9.js"><link rel="prefetch" href="/assets/js/79.6407212c.js"><link rel="prefetch" href="/assets/js/8.f8c818df.js"><link rel="prefetch" href="/assets/js/80.6554cb4c.js"><link rel="prefetch" href="/assets/js/81.84c710c0.js"><link rel="prefetch" href="/assets/js/82.32cdc5bb.js"><link rel="prefetch" href="/assets/js/83.e08a0de0.js"><link rel="prefetch" href="/assets/js/84.59fefb9d.js"><link rel="prefetch" href="/assets/js/85.af63859c.js"><link rel="prefetch" href="/assets/js/87.c45c0b70.js"><link rel="prefetch" href="/assets/js/88.92b080af.js"><link rel="prefetch" href="/assets/js/89.ad5aec24.js"><link rel="prefetch" href="/assets/js/9.6d13d821.js"><link rel="prefetch" href="/assets/js/90.a5156631.js"><link rel="prefetch" href="/assets/js/91.fac5ac80.js"><link rel="prefetch" href="/assets/js/92.07aa1e42.js"><link rel="prefetch" href="/assets/js/93.c5f9a0d5.js"><link rel="prefetch" href="/assets/js/94.e05d5d7e.js"><link rel="prefetch" href="/assets/js/95.fea62791.js"><link rel="prefetch" href="/assets/js/96.449a8e88.js"><link rel="prefetch" href="/assets/js/97.94f2a5fd.js">
    <link rel="stylesheet" href="/assets/css/1.styles.b05fc641.css"><link rel="stylesheet" href="/assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="/assets/css/styles.bb1fe17d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">大坚博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">客户端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/android/Activity生命周期.html" class="nav-link">Android</a></li><li class="dropdown-item"><!----> <a href="/html/CSS的创建与表现.html" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/Spring.html" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">MySQL</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kotlin/Kotlin语法基础.html" class="nav-link">Kotlin</a></li><li class="dropdown-item"><!----> <a href="/java/Java平台.html" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/c/类型、运算符与表达式.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">Python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/设计模式基础.html" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/data-structure/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/network-and-security/" class="nav-link">网络与安全</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">系统与工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/mac/Homebrew.html" class="nav-link">Mac</a></li><li class="dropdown-item"><!----> <a href="/gradle/" class="nav-link">Gradle</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">多媒体</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opencv/搭建OpenCV Android项目.html" class="nav-link">OpenCV</a></li><li class="dropdown-item"><!----> <a href="/ffmpeg/macOS上编译FFmpeg.html" class="nav-link">FFmpeg</a></li></ul></div></div><div class="nav-item"><a href="/about-me/" class="nav-link">关于我</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">客户端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/android/Activity生命周期.html" class="nav-link">Android</a></li><li class="dropdown-item"><!----> <a href="/html/CSS的创建与表现.html" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/Spring.html" class="nav-link">Spring</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/mysql/" class="nav-link">MySQL</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/kotlin/Kotlin语法基础.html" class="nav-link">Kotlin</a></li><li class="dropdown-item"><!----> <a href="/java/Java平台.html" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/c/类型、运算符与表达式.html" class="nav-link">C</a></li><li class="dropdown-item"><!----> <a href="/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/python/" class="nav-link">Python</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">编程</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/design-pattern/设计模式基础.html" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/data-structure/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/network-and-security/" class="nav-link">网络与安全</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">系统与工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/mac/Homebrew.html" class="nav-link">Mac</a></li><li class="dropdown-item"><!----> <a href="/gradle/" class="nav-link">Gradle</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/tool/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">多媒体</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/opencv/搭建OpenCV Android项目.html" class="nav-link">OpenCV</a></li><li class="dropdown-item"><!----> <a href="/ffmpeg/macOS上编译FFmpeg.html" class="nav-link">FFmpeg</a></li></ul></div></div><div class="nav-item"><a href="/about-me/" class="nav-link">关于我</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>Spring</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/spring/Spring.html" class="sidebar-link">Spring</a></li><li><a href="/spring/装配Bean.html" class="sidebar-link">装配Bean</a></li><li><a href="/spring/Bean的高级装配.html" class="active sidebar-link">Bean的高级装配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/spring/Bean的高级装配.html#环境与profile" class="sidebar-link">环境与Profile</a></li><li class="sidebar-sub-header"><a href="/spring/Bean的高级装配.html#条件化bean" class="sidebar-link">条件化Bean</a></li><li class="sidebar-sub-header"><a href="/spring/Bean的高级装配.html#自动装配的歧义性" class="sidebar-link">自动装配的歧义性</a></li><li class="sidebar-sub-header"><a href="/spring/Bean的高级装配.html#bean的作用域" class="sidebar-link">bean的作用域</a></li><li class="sidebar-sub-header"><a href="/spring/Bean的高级装配.html#运行时值注入" class="sidebar-link">运行时值注入</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Spring Boot</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="bean的高级装配"><a href="#bean的高级装配" aria-hidden="true" class="header-anchor">#</a> Bean的高级装配</h1> <p></p><div class="table-of-contents"><ul><li><a href="#环境与profile">环境与Profile</a><ul><li><a href="#配置profile-bean">配置profile bean</a></li><li><a href="#激活profile">激活profile</a></li></ul></li><li><a href="#条件化bean">条件化Bean</a></li><li><a href="#自动装配的歧义性">自动装配的歧义性</a><ul><li><a href="#首选bean">首选bean</a></li><li><a href="#限定符">限定符</a></li></ul></li><li><a href="#bean的作用域">bean的作用域</a><ul><li><a href="#作用域种类">作用域种类</a></li><li><a href="#作用域代理">作用域代理</a></li></ul></li><li><a href="#运行时值注入">运行时值注入</a><ul><li><a href="#属性占位符">属性占位符</a></li></ul></li></ul></div><p></p> <h2 id="环境与profile"><a href="#环境与profile" aria-hidden="true" class="header-anchor">#</a> 环境与Profile</h2> <h3 id="配置profile-bean"><a href="#配置profile-bean" aria-hidden="true" class="header-anchor">#</a> 配置profile bean</h3> <p>Spring 3.1引入了profile bean功能：为某个bean指定它所属的profile环境，当该profile处于active状态时，这个bean定义才有效。</p> <p>在Java配置中，可以使用<code>@Profile</code>注解来指定某个bean属于哪一个profile。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Configuration</span>
<span class="token annotation builtin">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> DevelopmentProfileConfig <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在上面的例子中，将<code>@Profile</code>注解应用在类级别上，表示这个配置类中定义的bean只有在dev profile激活时才有效。若dev profile没有激活，这个类中带有<code>@Bean</code>注解的方法都会被忽略。</p> <p>在Spring 3.1中，只能在类级别上使用<code>@Profile</code>注解。从Spring 3.2开始，可以在方法级别上使用。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Configuration</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> DevelopmentProfileConfig <span class="token punctuation">{</span>

    <span class="token annotation builtin">@Bean</span>
    <span class="token annotation builtin">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">embeddedDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> DataSource <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation builtin">@Bean</span>
    <span class="token annotation builtin">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;prod&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">jndiDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> DataSource <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>可以通过<code>&lt;beans&gt;</code>元素的<strong>profile属性</strong>，在XML中配置profile bean。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dev<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- ... --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以在XML文件的根<code>&lt;beans&gt;</code>元素中嵌套定义<code>&lt;beans&gt;</code>元素，每个<code>&lt;beans&gt;</code>元素负责一个profile环境的定义，这样就能够将所有profile bean定义放在同一个XML文件中。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dev<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- ... --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>prod<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- ... --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="激活profile"><a href="#激活profile" aria-hidden="true" class="header-anchor">#</a> 激活profile</h3> <p>Spring依赖<code>spring.profiles.active</code>和<code>spring.profiles.default</code>这两个独立的属性来确定哪个profile是激活的。</p> <ol><li>如果设置了<code>spring.profiles.active</code>，那么就用它的值来确定要激活的profile。</li> <li>如果没有设置<code>spring.profiles.active</code>，就查找<code>spring.profiles.default</code>值。</li> <li>如果两个值都没有设置，那就没有激活的profile，因此只会创建那些没有定义在profile中的bean。</li></ol> <p>有多种方式来设置这两个属性：</p> <ul><li>作为DispatcherServlet的初始化参数。</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- web.xml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>appServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>
            org.springframework.web.servlet.DispatcherServlet
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>spring.profiles.default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>dev<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>作为Web应用的上下文参数。</li></ul> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- web.xml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>context-param</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>spring.profiles.default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>dev<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>context-param</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li><p>作为JNDI条目。</p></li> <li><p>作为环境变量。</p></li> <li><p>作为JVM的系统属性。</p></li> <li><p>在集成测试类上，使用<code>@ActiveProfiles</code>注解来设置。</p></li></ul> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@RunWith</span><span class="token punctuation">(</span>SpringJUnit4ClassRunner<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@ContextConfiguration</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token punctuation">[</span>SystemConfig<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@ActiveProfiles</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> CDPlayerTest <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>其实，这两个属性都可以同时赋予多个profile名称，用逗号分割。</p> <h2 id="条件化bean"><a href="#条件化bean" aria-hidden="true" class="header-anchor">#</a> 条件化Bean</h2> <p>Spring 4引入了一个新的<code>@Conditional</code>注解，它和<code>@Bean</code>注解一起使用。如果指定的条件成立，就会创建对应的Bean，否则会忽略这个Bean定义。</p> <p><code>@Conditional</code>注解接收一个Class类为参数，该类可以是任意实现了Condition接口的类型。这个Condition实现类要实现<code>matches()</code>方法，此方法的Boolean结果决定是否创建<code>@Conditional</code>注解对应的Bean。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Condition
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>ConditionContext
<span class="token keyword">import</span> org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>type<span class="token punctuation">.</span>AnnotatedTypeMetadata

<span class="token keyword">class</span> MagicExistsCondition <span class="token operator">:</span> Condition <span class="token punctuation">{</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">matches</span><span class="token punctuation">(</span>context<span class="token operator">:</span> ConditionContext<span class="token punctuation">,</span> metadata<span class="token operator">:</span> AnnotatedTypeMetadata<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token comment">// 检查环境中是否存在magic属性</span>
        <span class="token keyword">val</span> env <span class="token operator">=</span> context<span class="token punctuation">.</span>environment
        <span class="token keyword">return</span> env<span class="token punctuation">.</span><span class="token function">containsProperty</span><span class="token punctuation">(</span><span class="token string">&quot;magic&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// MagicExistsCondition的matches方法返回true时，才会创建MagicBean</span>
<span class="token annotation builtin">@Bean</span>
<span class="token annotation builtin">@Conditional</span><span class="token punctuation">(</span>MagicExistsCondition<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">magicBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> MagicBean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">MagicBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>善于利用<code>matches()</code>方法中的ConditionContext和AnnotatedTypeMetadata对象来做条件判断的决策。</p> <p>通过ConditionContext，可做到如下几点：</p> <ul><li>借助<code>getRegistry()</code>返回的BeanDefinitionRegistry检查bean定义。</li> <li>借助<code>getBeanFactory()</code>返回的ConfigurableListableBeanFactory检查bean是否存在，甚至探查bean的属性。</li> <li>借助<code>getEnvironment()</code>返回的Environment检查环境变量是否存在指定属性，以及其值是什么。</li> <li>借助<code>getResourceLoader()</code>返回的ResourceLoader读取并探查所加载的资源。</li> <li>借助<code>getClassLoader()</code>返回的ClassLoader加载并检查类是否存在。</li></ul> <h2 id="自动装配的歧义性"><a href="#自动装配的歧义性" aria-hidden="true" class="header-anchor">#</a> 自动装配的歧义性</h2> <p>仅有一个bean匹配时，Spring自动装配能正常工作。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">interface</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Component</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Cake <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;Cake&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Autowired</span>
<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> dessert<span class="token operator">:</span> Dessert
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果有多于一个的bean能够匹配时，这种歧义性会阻碍Spring自动装配，并抛出NoUniqueBeanDefinitionException。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">interface</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Component</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Cake <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;Cake&quot;</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Component</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Cookie <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;Cookie&quot;</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Component</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> IceCream <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;IceCream&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>解决这种歧义性的方法有：</p> <ul><li><p>将可选bean中的某一个设为首选（primary bean）。</p></li> <li><p>使用限定符（qualifier）来帮助Spring将可选bean的范围缩小到只有一个。</p></li></ul> <h3 id="首选bean"><a href="#首选bean" aria-hidden="true" class="header-anchor">#</a> 首选bean</h3> <p>在声明bean时，通过将其中一个可选bean设为首选bean，能够避免自动装配时的歧义性。当遇到歧义性时，Spring将会使用首选bean。</p> <p>使用<code>@Primary</code>来声明首选bean。</p> <ul><li>它能够与<code>@Component</code>组合用在组件扫描的bean上。</li></ul> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Component</span>
<span class="token annotation builtin">@Primary</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Cake <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;Cake&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>也可以将它与<code>@Bean</code>组合用在Java配置的bean声明中。</li></ul> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Bean</span>
<span class="token annotation builtin">@Primary</span>
<span class="token keyword">fun</span> Dessert <span class="token function">cake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Cake</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果使用XML配置，可使用<code>&lt;bean&gt;</code>元素中的primary属性来指定首选bean。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cake<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>tech.daking.bean.Cake<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">primary</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意，首选bean要确保只有一个，若有多个首选bean，Spring自动装配的歧义性就再次出现。</p> <h3 id="限定符"><a href="#限定符" aria-hidden="true" class="header-anchor">#</a> 限定符</h3> <p>首选bean只能标示一个优先的可选方案，而无法将可选方案限定到唯一一个无歧义性的结果。</p> <p>而Spring限定符能够在所有可选的bean上进行缩小范围的操作，最终能够达到只有一个bean满足所规定的限制条件。</p> <h4 id="默认限定符"><a href="#默认限定符" aria-hidden="true" class="header-anchor">#</a> 默认限定符</h4> <p>所有bean都会给定一个默认的限定符，其值与bean的ID相同。</p> <p><code>@Qualifier</code>注解可以与<code>@Autowired</code>和<code>@Inject</code>协同使用，在注入时指明要注入规定限定符的bean。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// 创建ID为cookie的bean，因此，bean的限定符为cookie</span>
<span class="token annotation builtin">@Component</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Cookie <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;Cookie&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token comment">// 指定注入限定符为cookie的bean</span>
<span class="token annotation builtin">@Autowired</span>
<span class="token annotation builtin">@Qualifier</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cookie&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> Cookie<span class="token operator">:</span> Dessert
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="自定义的限定符"><a href="#自定义的限定符" aria-hidden="true" class="header-anchor">#</a> 自定义的限定符</h4> <p>可以为bean设置自定义的限定符，而不依赖于其bean ID。</p> <p>在bean声明上添加<code>@Qualifier</code>注解来创建自定义的限定符。</p> <ul><li>在<code>@Component</code>的bean声明上使用<code>@Qualifier</code>创建自定义的限定符。</li></ul> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Component</span>
<span class="token annotation builtin">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;cold&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> IceCream <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;IceCream&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>在<code>@Bean</code>的bean声明上使用<code>@Qualifier</code>创建自定义的限定符。</li></ul> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Bean</span>
<span class="token annotation builtin">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;cold&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">cold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Dessert <span class="token operator">=</span> <span class="token function">IceCream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在注入时使用<code>@Qualifier</code>注解引用指定的自定义限定符。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Autowired</span>
<span class="token annotation builtin">@Qualifier</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cold&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> cold<span class="token operator">:</span> Dessert
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="自定义的限定符注解"><a href="#自定义的限定符注解" aria-hidden="true" class="header-anchor">#</a> 自定义的限定符注解</h4> <p>可以创建自定义的限定符注解来表达bean所希望限定的特性。</p> <p>首先，定义一个新的自定义的限定符注解。在定义该注解时必须添加<code>@Qualifier</code>注解，让其具有<code>@Qualifier</code>注解的特性。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Target</span><span class="token punctuation">(</span>AnnotationTarget<span class="token punctuation">.</span>CLASS<span class="token punctuation">,</span> AnnotationTarget<span class="token punctuation">.</span>CONSTRUCTOR<span class="token punctuation">,</span>
        AnnotationTarget<span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> AnnotationTarget<span class="token punctuation">.</span>FUNCTION<span class="token punctuation">,</span> AnnotationTarget<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation builtin">@Retention</span><span class="token punctuation">(</span>AnnotationRetention<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation builtin">@Qualifier</span>
<span class="token keyword">annotation</span> <span class="token keyword">class</span> Cold
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接着，为bean添加该自定义的限定符注解。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Component</span>
<span class="token annotation builtin">@Cold</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> IceCream <span class="token operator">:</span> Dessert <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;IceCream&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后，在注入时使用自定义的限定符注解。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Autowired</span>
<span class="token annotation builtin">@Cold</span>
<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> cold<span class="token operator">:</span> Dessert
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可同时使用多个这样的自定义的限定符注解，从而将可选范围缩小到只有一个bean满足需求。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Autowired</span>
<span class="token annotation builtin">@Cold</span>
<span class="token annotation builtin">@Creamy</span>
<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> cold<span class="token operator">:</span> Dessert
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="bean的作用域"><a href="#bean的作用域" aria-hidden="true" class="header-anchor">#</a> bean的作用域</h2> <h3 id="作用域种类"><a href="#作用域种类" aria-hidden="true" class="header-anchor">#</a> 作用域种类</h3> <p>默认情况下，Spring应用上下文中所有bean都是以单例的形式创建的。</p> <p>Spring定义了多种作用域，可以基于它们来创建bean。</p> <ul><li><p>单例（Singleton）：在整个应用中，只创建一个bean实例。</p></li> <li><p>原型（Prototype）：每次注入或者通过Spring应用上下文获取时，都会创建一个新的bean实例。</p></li> <li><p>会话（Session）：在Web应用中，为每个会话创建一个bean实例。</p></li> <li><p>请求（Request）：在Web应用中，为每次请求创建一个bean实例。</p></li></ul> <p>在bean声明（<code>@Component</code>或<code>@Bean</code>）上使用<code>@Scope</code>来指定该bean的作用域。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Component</span>
<span class="token annotation builtin">@Scope</span><span class="token punctuation">(</span>ConfigurableBeanFactory<span class="token punctuation">.</span>SCOPE_PROTOTYPE<span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> Cookie <span class="token operator">:</span> Dessert <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意，<em>单例</em>和<em>原型</em>作用域分别使用Spring库中的<em>ConfigurableBeanFactory</em>类的<em>SCOPE_SINGLETON</em>和<em>SCOPE_PROTOTYPE</em>。而<em>会话</em>和<em>请求</em>作用域分别使用Spring Web库中的<em>WebApplicationContext</em>类的<em>SCOPE_SESSION</em>和<em>SCOPE_REQUEST</em>。</p> <p>如果是XML配置，使用<code>&lt;bean&gt;</code>元素的<strong>scope属性</strong>来指定该bean的作用域。各作用域对应的字符串分别为：singleton、prototype、session和request。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cookie<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>tech.daking.bean.Cookie<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>prototype<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="作用域代理"><a href="#作用域代理" aria-hidden="true" class="header-anchor">#</a> 作用域代理</h3> <p>在Web应用中，常常使用会话或请求作用域来声明一些与用户或网络请求相关的bean。比如，购物车bean。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Component</span>
<span class="token annotation builtin">@Scope</span><span class="token punctuation">(</span>value <span class="token operator">=</span> WebApplicationContext<span class="token punctuation">.</span>SCOPE_SESSION<span class="token punctuation">,</span>
        proxyMode <span class="token operator">=</span> ScopedProxyMode<span class="token punctuation">.</span>TARGET_CLASS<span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> ShoppingCart <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的ShoppingCart bean，<code>@Scope</code>注解的value属性设为<code>WebApplicationContext.SCOPE_SESSION</code>，表明这是一个会话作用域的bean。而<code>proxyMode</code>属性是设置该bean的作用域代理，下面进行重点讲述。</p> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Component</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> StoreService <span class="token punctuation">{</span>
    <span class="token annotation builtin">@Autowired</span>
    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> shoppingCart<span class="token operator">:</span> ShoppingCart
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面的StoreService bean是一个单例bean，会在Spring应用上下文加载时创建。当它创建时，Spring会试图将ShoppingCart bean注入到其shoppingCart字段中。但ShoppingCart bean是会话作用域，此时并不存在，要直到某个用户创建会话才会出现ShoppingCart实例。</p> <p>另外，系统中会有多个ShoppingCart bean实例（每个用户对应一个），我们不能让某个固定的ShoppingCart bean实例注入到StoreService bean中。</p> <p>因此，要使用<strong>作用域代理</strong>机制让一个<strong>ShoppingCart bean代理</strong>注入到StoreService bean中，当调用ShoppingCart的方法时，<strong>该代理会对其进行懒解析并委托给会话作用域内真正的ShoppingCart bean实例</strong>来处理。</p> <p><img src="/15267167746675/15318149555135.jpg" alt="会话或请求作用域的代理-w505"></p> <p><code>@Scope</code>注解的proxyMode属性值为ScopedProxyMode枚举类对象，有以下几个可选值：</p> <ul><li><p><code>DEFAULT</code>：默认代理模式。默认情况下等同于NO，除非在组件扫描指令级别中修改了默认代理模式。</p></li> <li><p><code>NO</code>：不创建作用域代理。</p></li> <li><p><code>INTERFACES</code>：利用JDK动态代理来创建一个基于接口的代理对象。若bean是接口，使用此代理模式。</p></li> <li><p><code>TARGET_CLASS</code>：使用CGLIB来创建一个扩展目标类的代理对象。若bean是类，使用此代理模式。</p></li></ul> <p>如果是XML配置，在<code>&lt;bean&gt;</code>元素中使用Spring aop命名空间中的<code>&lt;aop:scoped-proxy&gt;</code>子元素来指定作用域的代理模式。</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cart<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>tech.daking.bean.ShoppingCart<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>session<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>scoped-proxy</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>&lt;aop:scoped-proxy&gt;</code>默认是使用CGLIB创建目标类的代理，可将其<code>proxy-target-class</code>属性设为false让它生成基于接口的代理。</p> <h2 id="运行时值注入"><a href="#运行时值注入" aria-hidden="true" class="header-anchor">#</a> 运行时值注入</h2> <p>Spring的依赖注入，不仅支持将一个bean对象注入到另一个bean对象的属性或构造器参数中，还支持将一个值注入到一个bean的属性或构造器参数中。</p> <p>Spring提供了两种在运行时注入值的方法：</p> <ul><li><p>属性占位符（Property placeholder）。</p></li> <li><p>Spring表达式语言（SpEL）。</p></li></ul> <h3 id="属性占位符"><a href="#属性占位符" aria-hidden="true" class="header-anchor">#</a> 属性占位符</h3> <div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token keyword">class</span> <span class="token function">BlankDisc</span><span class="token punctuation">(</span><span class="token keyword">val</span> title<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">val</span> artist<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Playing <span class="token interpolation variable">$title</span> by <span class="token interpolation variable">$artist</span>.&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code># src/main/resources/app.properties
disc.title=Jay
disc.artist=Jay Chou
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Configuration</span>
<span class="token annotation builtin">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:app.properties&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">open</span> <span class="token keyword">class</span> CDPlayerConfig <span class="token punctuation">{</span>
    <span class="token annotation builtin">@Autowired</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> env<span class="token operator">:</span> Environment

    <span class="token annotation builtin">@Bean</span>
    <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">blankDisc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> BlankDisc <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">BlankDisc</span><span class="token punctuation">(</span>
                env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;disc.title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;disc.artist&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-kotlin line-numbers-mode"><pre class="language-kotlin"><code><span class="token annotation builtin">@Autowired</span>
<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> blankDisc<span class="token operator">:</span> BlankDisc

<span class="token annotation builtin">@Test</span>
<span class="token keyword">fun</span> <span class="token function">playBlankDisc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    blankDisc<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Playing Jay by Jay Chou.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/86.513e36a1.js" defer></script><script src="/assets/js/app.bb1fe17d.js" defer></script>
  </body>
</html>
