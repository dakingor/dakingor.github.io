(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{149:function(a,s,t){"use strict";t.r(s);var n=t(0),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("div",{staticClass:"content"},[t("h1",{attrs:{id:"aidl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL")]),a._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#aidl"}},[a._v("AIDL")])]),t("li",[t("a",{attrs:{href:"#定义aidl服务"}},[a._v("定义AIDL服务")]),t("ul",[t("li",[t("a",{attrs:{href:"#aidl接口的创建"}},[a._v("AIDL接口的创建")])]),t("li",[t("a",{attrs:{href:"#aidl接口的编码实现"}},[a._v("AIDL接口的编码实现")])]),t("li",[t("a",{attrs:{href:"#服务端的实现"}},[a._v("服务端的实现")])]),t("li",[t("a",{attrs:{href:"#客户端的实现"}},[a._v("客户端的实现")])])])]),t("li",[t("a",{attrs:{href:"#传递复杂对象"}},[a._v("传递复杂对象")])]),t("li",[t("a",{attrs:{href:"#aidl服务回调客户端"}},[a._v("AIDL服务回调客户端")]),t("ul",[t("li",[t("a",{attrs:{href:"#回调原理"}},[a._v("回调原理")])]),t("li",[t("a",{attrs:{href:"#回调listener的定义"}},[a._v("回调Listener的定义")])]),t("li",[t("a",{attrs:{href:"#注册和注销回调listener"}},[a._v("注册和注销回调Listener")])]),t("li",[t("a",{attrs:{href:"#服务端的实现"}},[a._v("服务端的实现")])]),t("li",[t("a",{attrs:{href:"#客户端的实现"}},[a._v("客户端的实现")])]),t("li",[t("a",{attrs:{href:"#remotecallbacklist"}},[a._v("RemoteCallbackList")])])])]),t("li",[t("a",{attrs:{href:"#binder的死亡"}},[a._v("Binder的死亡")])]),t("li",[t("a",{attrs:{href:"#aidl权限验证"}},[a._v("AIDL权限验证")]),t("ul",[t("li",[t("a",{attrs:{href:"#在-onbind-中进行验证"}},[a._v("在onBind()中进行验证")])]),t("li",[t("a",{attrs:{href:"#在-ontransact-中进行验证"}},[a._v("在onTransact()中进行验证")])]),t("li",[t("a",{attrs:{href:"#其他验证方法"}},[a._v("其他验证方法")])])])]),t("li",[t("a",{attrs:{href:"#aidl与线程"}},[a._v("AIDL与线程")]),t("ul",[t("li",[t("a",{attrs:{href:"#客户端调用服务端"}},[a._v("客户端调用服务端")])]),t("li",[t("a",{attrs:{href:"#服务端回调客户端"}},[a._v("服务端回调客户端")])])])]),t("li",[t("a",{attrs:{href:"#aidl升级"}},[a._v("AIDL升级")])])])]),t("p"),a._v(" "),t("h2",{attrs:{id:"aidl-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl-2","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL")]),a._v(" "),t("p",[a._v("全称Android Interface Definition Language。")]),a._v(" "),t("p",[a._v("像其他IDLs一样，允许你定义编程接口，实现客户端和服务端之间的内部进程通信(Inter Process Communication, IPC)。")]),a._v(" "),t("p",[a._v("AIDL通信分为两部分：")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("服务端，即提供AIDL服务的进程。")])]),a._v(" "),t("li",[t("p",[a._v("客户端，即调用AIDL服务的进程。")])])]),a._v(" "),t("h2",{attrs:{id:"定义aidl服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定义aidl服务","aria-hidden":"true"}},[a._v("#")]),a._v(" 定义AIDL服务")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("创建AIDL接口：创建"),t("code",[a._v(".aidl")]),a._v("文件，定义对外提供服务的方法。")])]),a._v(" "),t("li",[t("p",[a._v("AIDL接口的编码实现：Android SDK工具基于AIDL接口文件，在编译时使用Java语言生成一个与"),t("code",[a._v(".aidl")]),a._v("文件同名的"),t("code",[a._v(".java")]),a._v("文件。")])]),a._v(" "),t("li",[t("p",[a._v("实现服务端：创建一个Service，重写"),t("code",[a._v("onBind()")]),a._v("返回AIDL接口的实现对象。")])]),a._v(" "),t("li",[t("p",[a._v("实现客户端：绑定远程服务，将服务端返回的IBinder对象转变成AIDL接口类型，接着调用AIDL接口中公开声明的方法。")])])]),a._v(" "),t("h3",{attrs:{id:"aidl接口的创建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl接口的创建","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL接口的创建")]),a._v(" "),t("p",[a._v("创建一个后缀为aidl的文件，在这个文件中声明将暴露给客户端的接口方法。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token comment"}},[a._v("// IRemoteService.aidl")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("package")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{attrs:{class:"token keyword"}},[a._v("interface")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IRemoteService")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    String "),t("span",{attrs:{class:"token function"}},[a._v("getName")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("p",[a._v("AIDL支持以下数据类型：")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("Java基本类型，即int、long、char等。")])]),a._v(" "),t("li",[t("p",[a._v("String和CharSequence。")])]),a._v(" "),t("li",[t("p",[a._v("List：其中的每个元素都必须是AIDL支持的。客户端实际接收的具体类始终是"),t("strong",[a._v("ArrayList")]),a._v("，但生成的方法使用的是List接口。")])]),a._v(" "),t("li",[t("p",[a._v("Map：其中的每个元素都必须是AIDL支持的。客户端实际接收的具体类始终是"),t("strong",[a._v("HashMap")]),a._v("，但生成的方法使用的是Map接口。")])]),a._v(" "),t("li",[t("p",[a._v("Parcelable："),t("strong",[a._v("必须要显式import，即使它跟.aidl是同一个包下")]),a._v("。")])]),a._v(" "),t("li",[t("p",[a._v("AIDL接口："),t("strong",[a._v("必须要显式import，即使它跟.aidl是同一个包下")]),a._v("。")])])]),a._v(" "),t("p",[a._v("AIDL中的方法可有零、一或多个参数，可有返回值或void。")]),a._v(" "),t("p",[a._v("AIDL中除了基本数据类型（默认为in，不能是其他方向），其他类型的参数必须标上方向：")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("in，表示输入型参数，由客户端赋值；")])]),a._v(" "),t("li",[t("p",[a._v("out，表示输出型参数，由服务端赋值；")])]),a._v(" "),t("li",[t("p",[a._v("inout，表示输入输出型参数，可由客户端或服务端赋值；")])])]),a._v(" "),t("p",[a._v("AIDL只expose方法，"),t("strong",[a._v("不会expose静态变量")]),a._v("。")]),a._v(" "),t("h3",{attrs:{id:"aidl接口的编码实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl接口的编码实现","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL接口的编码实现")]),a._v(" "),t("p",[a._v("在AIDL的开发中，一般将所有和AIDL相关的类和文件全部放在同一个包中。这是因为若客户端与服务端位于不同的App中，客户端需要拷贝这些文件，且路径也要一致。AIDL文件一般保存在项目**"),t("code",[a._v("/src/<SourceSet>/aidl")]),a._v("**目录下。")]),a._v(" "),t("p",[a._v("当编译APP时，SDK工具会将项目**"),t("code",[a._v("/src/<SourceSet>/aidl")]),a._v("目录"),t("strong",[a._v("下的每个AIDL文件，在项目")]),t("code",[a._v("/build/generated/source/aidl")]),a._v("目录"),t("strong",[a._v("下生成对应的Java文件。两个文件的名称一样，只是后缀不同。如")]),a._v("IRemoteService.aidl生成IRemoteService.java**。")]),a._v(" "),t("h3",{attrs:{id:"服务端的实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务端的实现","aria-hidden":"true"}},[a._v("#")]),a._v(" 服务端的实现")]),a._v(" "),t("p",[a._v("创建一个Service，并在"),t("code",[a._v("onBind()")]),a._v("中返回"),t("code",[a._v("<AIDL接口>.Stub")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("package")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" android"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("app"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Service"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" android"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("content"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Intent"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" android"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("os"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("IBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" android"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("os"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RemoteException"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("RemoteService")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("extends")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("Service")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("RemoteService")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    \n    "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v(" \n    "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" IBinder "),t("span",{attrs:{class:"token function"}},[a._v("onBind")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Intent intent"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" mBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    \n    "),t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("final")]),a._v(" IRemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Stub mBinder "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IRemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Stub")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" String "),t("span",{attrs:{class:"token function"}},[a._v("getName")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" RemoteException "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{attrs:{class:"token string"}},[a._v('"I am com.daking.aidl.IRemoteService"')]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br")])]),t("p",[a._v("在AndroidManifest中配置"),t("code",[a._v("<service>")]),a._v("，"),t("code",[a._v("android:exported")]),a._v("属性设为true、设置自定义Action等。")]),a._v(" "),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("service")]),a._v("\n    "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("name")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v(".RemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n    "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("enabled")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("true"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n    "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("exported")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("true"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n    "),t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("intent-filter")]),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n        "),t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("action")]),a._v(" "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("name")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("com.daking.aidl.RemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n        "),t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("category")]),a._v(" "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("name")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("android.intent.category.DEFAULT"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n    "),t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("</")]),a._v("intent-filter")]),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n"),t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("</")]),a._v("service")]),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br")])]),t("h3",{attrs:{id:"客户端的实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端的实现","aria-hidden":"true"}},[a._v("#")]),a._v(" 客户端的实现")]),a._v(" "),t("p",[a._v("客户端的实现步骤为：")]),a._v(" "),t("ol",[t("li",[t("p",[a._v("绑定服务端Service。")])]),a._v(" "),t("li",[t("p",[a._v("在绑定成功的回调中，将服务端返回的IBinder对象转换成AIDL接口类型。")])]),a._v(" "),t("li",[t("p",[a._v("调用这个AIDL接口的公开方法。")])])]),a._v(" "),t("p",[a._v("绑定AIDL服务：")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("Intent intent "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("Intent")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token comment"}},[a._v("// 提供AIDL服务的App包名")]),a._v("\nintent"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("setPackage")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token string"}},[a._v('"com.daking.aidl"')]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token comment"}},[a._v("// AIDL服务的Action名")]),a._v("\nintent"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("setAction")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token string"}},[a._v('"com.daking.aidl.RemoteService"')]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token function"}},[a._v("bindService")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("intent"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" serviceConnection"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Context"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("BIND_AUTO_CREATE"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("p",[a._v("在绑定成功的回调中，将服务端返回的IBinder对象转换成AIDL接口：")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" IRemoteService mIRemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("onServiceConnected")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ComponentName className"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" IBinder service"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    mIRemoteService "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" IRemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Stub"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("asInterface")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("service"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("通过这个AIDL接口去调用服务端的远程方法。注意，AIDL服务默认是"),t("strong",[a._v("运行在主线程中且是同步操作")]),a._v("，若里面有耗时操作，应该在子线程中调用AIDL。")]),a._v(" "),t("p",[a._v("若客户端和服务端位于不同App，那么客户端必须要有涉及到的AIDL相关的类和文件的副本，一般保存目录为"),t("code",[a._v("/src/<SourceSet>/aidl")]),a._v("。")]),a._v(" "),t("h2",{attrs:{id:"传递复杂对象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#传递复杂对象","aria-hidden":"true"}},[a._v("#")]),a._v(" 传递复杂对象")]),a._v(" "),t("p",[a._v("在AIDL中传递的复杂对象必须要实现"),t("strong",[a._v("Parcelable")]),a._v("接口，这是因为Parcelable允许Android系统将复杂对象分解成基本类型以便在进程间传输。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("RequestVO")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("implements")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("Parcelable")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" String name"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" String type"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    \n    "),t("span",{attrs:{class:"token comment"}},[a._v("// 忽略Parcelable实现")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br")])]),t("p",[a._v("Parcelable的实现可手动编码，也可利用插件来自动编码，如Android Studio的"),t("strong",[a._v("Android Parcelable code generator插件")]),a._v("。")]),a._v(" "),t("p",[a._v("若客户端和服务端位于不同App，必须要"),t("strong",[a._v("把"),t("code",[a._v("该Parcelable实现类.java")]),a._v("文件拷贝到客户端所在的APP，包路径要一致")]),a._v("。")]),a._v(" "),t("p",[a._v("另外，需要为这个Parcelable实现类定义一个相应的AIDL文件。客户端的对应目录下也要有这份副本。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token comment"}},[a._v("// RequestVO.aidl")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("package")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\nparcelable RequestVO"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br")])]),t("p",[a._v("将复杂对象作为AIDL接口的形参时，记得加上"),t("code",[a._v("in")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token comment"}},[a._v("// IRemoteService.aidl")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RequestVO"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\n"),t("span",{attrs:{class:"token keyword"}},[a._v("interface")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IRemoteService")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("request")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in RequestVO vo"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br")])]),t("h2",{attrs:{id:"aidl服务回调客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl服务回调客户端","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL服务回调客户端")]),a._v(" "),t("h3",{attrs:{id:"回调原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回调原理","aria-hidden":"true"}},[a._v("#")]),a._v(" 回调原理")]),a._v(" "),t("p",[a._v("服务端回调客户端，实际上是一个逆向的AIDL服务过程。")]),a._v(" "),t("p",[a._v("首先，客户端以AIDL接口方式定义一个监听器接口。接着，客户端调用服务端的注册方法，并传入监听器接口实现对象（AIDL的Stub对象，也是IBinder对象）。随后，服务端收到客户端的调用请求，将客户端传过来的IBinder对象转换成AIDL接口，这个AIDL接口类型变量就是监听器对象。（类似于之前的客户端绑定服务端的AIDL服务）")]),a._v(" "),t("p",[a._v("服务端调用这个AIDL接口类型变量的方法来回调信息给客户端。（类似于客户端调用服务端的AIDL接口提供的公开方法）")]),a._v(" "),t("h3",{attrs:{id:"回调listener的定义"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#回调listener的定义","aria-hidden":"true"}},[a._v("#")]),a._v(" 回调Listener的定义")]),a._v(" "),t("p",[a._v("自定义"),t("code",[a._v("回调接口.aidl")]),a._v("。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token comment"}},[a._v("// ICallback.aidl")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("package")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("ResponseVO"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\n"),t("span",{attrs:{class:"token keyword"}},[a._v("interface")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("ICallback")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("onResult")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in ResponseVO vo"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])]),t("h3",{attrs:{id:"注册和注销回调listener"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注册和注销回调listener","aria-hidden":"true"}},[a._v("#")]),a._v(" 注册和注销回调Listener")]),a._v(" "),t("p",[t("code",[a._v("AIDL服务.aidl")]),a._v("提供接口给客户端注册和注销回调。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token comment"}},[a._v("// IRemoteService.aidl")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("package")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("RequestVO"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("import")]),a._v(" com"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("daking"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("aidl"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("ICallback"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\t\n"),t("span",{attrs:{class:"token keyword"}},[a._v("interface")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IRemoteService")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("request")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in RequestVO vo"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("registerCallback")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in ICallback cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("unregisterCallback")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in ICallback cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br")])]),t("h3",{attrs:{id:"服务端的实现-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务端的实现-2","aria-hidden":"true"}},[a._v("#")]),a._v(" 服务端的实现")]),a._v(" "),t("p",[t("code",[a._v("AIDL服务.java")]),a._v("的具体实现。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token comment"}},[a._v("// RemoteService.java")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("RemoteService")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("extends")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("Service")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" RemoteCallbackList"),t("span",{attrs:{class:"token generics function"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("ICallback"),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    \n    "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" IBinder "),t("span",{attrs:{class:"token function"}},[a._v("onBind")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Intent intent"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        icallbacks "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("RemoteCallback")]),t("span",{attrs:{class:"token generics function"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("ICallback"),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" mBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    \n    "),t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("final")]),a._v(" IRemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Stub mBinder "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IRemoteService"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Stub")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("request")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in RequestVO vo"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{attrs:{class:"token function"}},[a._v("sendResponse")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        \n        "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("registerCallback")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in ICallback cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("cb "),t("span",{attrs:{class:"token operator"}},[a._v("!=")]),a._v(" null"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("register")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        \n        "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("unregisterCallback")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("in ICallback cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("cb "),t("span",{attrs:{class:"token operator"}},[a._v("!=")]),a._v(" null"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("unregister")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    \n    "),t("span",{attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("sendResponse")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        ResponseVO vo "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("ResponseVO")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        \n        "),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" len "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("beginBroadcast")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token number"}},[a._v("0")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i "),t("span",{attrs:{class:"token operator"}},[a._v("<")]),a._v(" len"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),t("span",{attrs:{class:"token operator"}},[a._v("++")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            ICallback cb "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("getBroadcastItem")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("i"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{attrs:{class:"token keyword"}},[a._v("try")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                cb"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("onResult")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("vo"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("catch")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token class-name"}},[a._v("RemoteException")]),a._v(" e"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                e"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("printStackTrace")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("finishBroadcast")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br"),t("span",{staticClass:"line-number"},[a._v("19")]),t("br"),t("span",{staticClass:"line-number"},[a._v("20")]),t("br"),t("span",{staticClass:"line-number"},[a._v("21")]),t("br"),t("span",{staticClass:"line-number"},[a._v("22")]),t("br"),t("span",{staticClass:"line-number"},[a._v("23")]),t("br"),t("span",{staticClass:"line-number"},[a._v("24")]),t("br"),t("span",{staticClass:"line-number"},[a._v("25")]),t("br"),t("span",{staticClass:"line-number"},[a._v("26")]),t("br"),t("span",{staticClass:"line-number"},[a._v("27")]),t("br"),t("span",{staticClass:"line-number"},[a._v("28")]),t("br"),t("span",{staticClass:"line-number"},[a._v("29")]),t("br"),t("span",{staticClass:"line-number"},[a._v("30")]),t("br"),t("span",{staticClass:"line-number"},[a._v("31")]),t("br"),t("span",{staticClass:"line-number"},[a._v("32")]),t("br"),t("span",{staticClass:"line-number"},[a._v("33")]),t("br"),t("span",{staticClass:"line-number"},[a._v("34")]),t("br"),t("span",{staticClass:"line-number"},[a._v("35")]),t("br"),t("span",{staticClass:"line-number"},[a._v("36")]),t("br"),t("span",{staticClass:"line-number"},[a._v("37")]),t("br"),t("span",{staticClass:"line-number"},[a._v("38")]),t("br"),t("span",{staticClass:"line-number"},[a._v("39")]),t("br"),t("span",{staticClass:"line-number"},[a._v("40")]),t("br"),t("span",{staticClass:"line-number"},[a._v("41")]),t("br"),t("span",{staticClass:"line-number"},[a._v("42")]),t("br"),t("span",{staticClass:"line-number"},[a._v("43")]),t("br"),t("span",{staticClass:"line-number"},[a._v("44")]),t("br"),t("span",{staticClass:"line-number"},[a._v("45")]),t("br"),t("span",{staticClass:"line-number"},[a._v("46")]),t("br")])]),t("h3",{attrs:{id:"客户端的实现-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端的实现-2","aria-hidden":"true"}},[a._v("#")]),a._v(" 客户端的实现")]),a._v(" "),t("p",[a._v("客户端创建回调接口的实现对象，并注册到AIDL。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("protected")]),a._v(" ICallback callback "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("ICallback"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("Stub")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("onResult")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("ResponseVO vo"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token comment"}},[a._v("// AIDL回调客户端后的业务处理")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),t("span",{attrs:{class:"token comment"}},[a._v("// mService为AIDL接口")]),a._v("\nmService"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("registerCallback")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("callback"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br")])]),t("h3",{attrs:{id:"remotecallbacklist"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#remotecallbacklist","aria-hidden":"true"}},[a._v("#")]),a._v(" RemoteCallbackList")]),a._v(" "),t("p",[a._v("RemoteCallbackList是系统专门提供的用于注册和注销"),t("strong",[a._v("跨进程Listener")]),a._v("的接口。RemoteCallbackList是一个泛型，支持管理任意的AIDL接口（因为AIDL接口都是继承自IInterface）。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("RemoteCallbackList")]),t("span",{attrs:{class:"token operator"}},[a._v("<")]),a._v("E "),t("span",{attrs:{class:"token keyword"}},[a._v("extends")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IInterface")]),t("span",{attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("RemoteCallbackList的内部有一个Map结构专门用来保存所有的AIDL回调。这个Map的键是IBinder类型，value是Callback类型。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("ArrayMap"),t("span",{attrs:{class:"token generics function"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("IBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Callback"),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),a._v(" mCallbacks "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("ArrayMap")]),t("span",{attrs:{class:"token generics function"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("IBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Callback"),t("span",{attrs:{class:"token punctuation"}},[a._v(">")])]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("其中Callback是RemoteCallbackList的内部类，用它来封装真正的远程listener。因为listener实际上是一个Binder对象，Callback实现了"),t("code",[a._v("IBinder.DeathRecipient")]),a._v("接口，能监听到listener的死亡，并自动将其移出列表。")]),a._v(" "),t("p",[a._v("RemoteCallbackList中注册和注销跨进程Listener的方法（这两个方法内部实现了线程同步）：")]),a._v(" "),t("ul",[t("li",[t("p",[t("code",[a._v("boolean register(E callback)")])])]),a._v(" "),t("li",[t("p",[t("code",[a._v("boolean unregister(E callback)")])])])]),a._v(" "),t("p",[a._v("RemoteCallbackList的遍历，必须要在"),t("code",[a._v("beginBroadcast()")]),a._v("和"),t("code",[a._v("finishBroadcast()")]),a._v("中。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" len "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("beginBroadcast")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token number"}},[a._v("0")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i "),t("span",{attrs:{class:"token operator"}},[a._v("<")]),a._v(" len"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),t("span",{attrs:{class:"token operator"}},[a._v("++")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    ICallback cb "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" icallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("getBroadcastItem")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("i"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("cb "),t("span",{attrs:{class:"token operator"}},[a._v("!=")]),a._v(" null"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token comment"}},[a._v("// 回调处理")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\nicallbacks"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("finishBroadcast")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br")])]),t("h2",{attrs:{id:"binder的死亡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#binder的死亡","aria-hidden":"true"}},[a._v("#")]),a._v(" Binder的死亡")]),a._v(" "),t("p",[a._v("Binder是很可能意外死亡的，这往往是由于服务端进程意外停止了，在实际开发中需要监听Binder死亡然后进行重连。")]),a._v(" "),t("p",[a._v("调用"),t("code",[a._v("Binder#linkToDeath()")]),a._v("设置"),t("code",[a._v("IBinder.DeathRecipient")]),a._v("监听。当Binder死亡时，"),t("code",[a._v("DeathRecipient#binderDied()")]),a._v("会被回调。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[a._v("binder"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("linkToDeath")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),t("span",{attrs:{class:"token class-name"}},[a._v("IBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("DeathRecipient")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("binderDied")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token comment"}},[a._v("// Binder挂掉了...")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("另外，Service在crash或killed时，系统会回调"),t("code",[a._v("onServiceDisconnected()")]),a._v("，也意味着Binder已经死亡了。")]),a._v(" "),t("p",[a._v("上面两种方式都可以监听到Binder的死亡，区别在于："),t("code",[a._v("binderDied()")]),a._v("是在客户端的"),t("strong",[a._v("Binder线程池")]),a._v("中被回调，而"),t("code",[a._v("onServiceDisconnected()")]),a._v("是在客户端的"),t("strong",[a._v("UI线程")]),a._v("中被回调。")]),a._v(" "),t("h2",{attrs:{id:"aidl权限验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl权限验证","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL权限验证")]),a._v(" "),t("h3",{attrs:{id:"在onbind-中进行验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#在onbind-中进行验证","aria-hidden":"true"}},[a._v("#")]),a._v(" 在"),t("code",[a._v("onBind()")]),a._v("中进行验证")]),a._v(" "),t("p",[a._v("在服务端的"),t("code",[a._v("Service#onBind()")]),a._v("中进行验证，若验证不通过就直接返回null，这样验证失败的客户端就无法绑定服务，更无法调用AIDL接口的公开方法。")]),a._v(" "),t("p",[a._v("验证方式可以有很多种，比如使用自定义permission验证。")]),a._v(" "),t("p",[a._v("第一步，服务端的AndroidManifest中定义自定义权限。")]),a._v(" "),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("permission")]),a._v(" \n    "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("name")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("自定义权限名"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v("\n    "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("protectionLevel")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("normal"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("第二步，客户端的AndroidManifest中添加自定义权限。")]),a._v(" "),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token tag"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("<")]),a._v("uses-permission")]),a._v("\n    "),t("span",{attrs:{class:"token attr-name"}},[t("span",{attrs:{class:"token namespace"}},[a._v("android:")]),a._v("name")]),t("span",{attrs:{class:"token attr-value"}},[t("span",{attrs:{class:"token punctuation"}},[a._v("=")]),t("span",{attrs:{class:"token punctuation"}},[a._v('"')]),a._v("自定义权限名"),t("span",{attrs:{class:"token punctuation"}},[a._v('"')])]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("/>")])]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br")])]),t("p",[a._v("第三步，服务端检测调用方是否具有指定的权限，验证成功方可绑定服务。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" IBinder "),t("span",{attrs:{class:"token function"}},[a._v("onBind")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("Intent intent"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" check "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("checkCallingOrSelfPermission")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token string"}},[a._v('"自定义权限名"')]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("check "),t("span",{attrs:{class:"token operator"}},[a._v("==")]),a._v(" PackageManager"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("PERMISSION_DENIED"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" null"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" mBinder"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br")])]),t("h3",{attrs:{id:"在ontransact-中进行验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#在ontransact-中进行验证","aria-hidden":"true"}},[a._v("#")]),a._v(" 在"),t("code",[a._v("onTransact()")]),a._v("中进行验证")]),a._v(" "),t("p",[a._v("在服务端的"),t("code",[a._v("AIDL.Stub")]),a._v("对象的"),t("code",[a._v("onTransact()")]),a._v("中进行验证，如果验证失败就返回false，这样服务端就不会执行AIDL中的方法。")]),a._v(" "),t("p",[a._v("验证方式可以有很多种，比如像上面一样使用自定义permission验证，也可以验证Uid（通过"),t("code",[a._v("getCallingUid()")]),a._v("获取）和Pid（通过"),t("code",[a._v("getCallingPid()")]),a._v("获取）。")]),a._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("boolean")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("onTransact")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" code"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Parcel data"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" Parcel reply"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" flags"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" RemoteException "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("int")]),a._v(" check "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("checkCallingOrSelfPermission")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token string"}},[a._v('"自定义权限名"')]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("check "),t("span",{attrs:{class:"token operator"}},[a._v("==")]),a._v(" PackageManager"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("PERMISSION_DENIED"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{attrs:{class:"token boolean"}},[a._v("false")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    \n    String packageName "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" null"),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    String"),t("span",{attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" packageNames "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),t("span",{attrs:{class:"token function"}},[a._v("getPackageManager")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("getPackageForUid")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token function"}},[a._v("getCallingUid")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("packageNames "),t("span",{attrs:{class:"token operator"}},[a._v("!=")]),a._v(" null "),t("span",{attrs:{class:"token operator"}},[a._v("&&")]),a._v(" packageNames"),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),a._v("length "),t("span",{attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),t("span",{attrs:{class:"token number"}},[a._v("0")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        packageName "),t("span",{attrs:{class:"token operator"}},[a._v("=")]),a._v(" packageNames"),t("span",{attrs:{class:"token punctuation"}},[a._v("[")]),t("span",{attrs:{class:"token number"}},[a._v("0")]),t("span",{attrs:{class:"token punctuation"}},[a._v("]")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),t("span",{attrs:{class:"token operator"}},[a._v("!")]),t("span",{attrs:{class:"token string"}},[a._v('"指定包名"')]),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("equals")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("packageName"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),t("span",{attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{attrs:{class:"token boolean"}},[a._v("false")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    \n    "),t("span",{attrs:{class:"token comment"}},[a._v("// 执行AIDL中的方法")]),a._v("\n    "),t("span",{attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),t("span",{attrs:{class:"token keyword"}},[a._v("super")]),t("span",{attrs:{class:"token punctuation"}},[a._v(".")]),t("span",{attrs:{class:"token function"}},[a._v("onTransact")]),t("span",{attrs:{class:"token punctuation"}},[a._v("(")]),a._v("code"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" data"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" reply"),t("span",{attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" flags"),t("span",{attrs:{class:"token punctuation"}},[a._v(")")]),t("span",{attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),t("span",{attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br"),t("span",{staticClass:"line-number"},[a._v("6")]),t("br"),t("span",{staticClass:"line-number"},[a._v("7")]),t("br"),t("span",{staticClass:"line-number"},[a._v("8")]),t("br"),t("span",{staticClass:"line-number"},[a._v("9")]),t("br"),t("span",{staticClass:"line-number"},[a._v("10")]),t("br"),t("span",{staticClass:"line-number"},[a._v("11")]),t("br"),t("span",{staticClass:"line-number"},[a._v("12")]),t("br"),t("span",{staticClass:"line-number"},[a._v("13")]),t("br"),t("span",{staticClass:"line-number"},[a._v("14")]),t("br"),t("span",{staticClass:"line-number"},[a._v("15")]),t("br"),t("span",{staticClass:"line-number"},[a._v("16")]),t("br"),t("span",{staticClass:"line-number"},[a._v("17")]),t("br"),t("span",{staticClass:"line-number"},[a._v("18")]),t("br")])]),t("h3",{attrs:{id:"其他验证方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他验证方法","aria-hidden":"true"}},[a._v("#")]),a._v(" 其他验证方法")]),a._v(" "),t("p",[a._v("为Service指定"),t("code",[a._v("android:permission")]),a._v("属性，限制具有指定权限的客户端方可访问。")]),a._v(" "),t("h2",{attrs:{id:"aidl与线程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl与线程","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL与线程")]),a._v(" "),t("h3",{attrs:{id:"客户端调用服务端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端调用服务端","aria-hidden":"true"}},[a._v("#")]),a._v(" 客户端调用服务端")]),a._v(" "),t("p",[a._v("客户端调用远程方法，被调用的方法运行在服务端的Binder线程池中，同时客户端线程会被挂起。如果服务端方法执行比较耗时，就会导致客户端线程长时间的阻塞，而如果这个客户端线程是UI线程，就会导致客户端发生ANR。")]),a._v(" "),t("p",[a._v("避免在客户端的UI线程中去调用远程方法。")]),a._v(" "),t("p",[a._v("客户端的"),t("code",[a._v("onServiceConnected()")]),a._v("和"),t("code",[a._v("onServiceDisconnected()")]),a._v("都运行在UI线程中，所以不可以在它们里面直接调用远程方法。")]),a._v(" "),t("p",[a._v("因为服务端的方法被调用时是运行在Binder线程池中，本身就可以执行耗时操作，因此不需要另外再开线程去进行异步任务。")]),a._v(" "),t("h3",{attrs:{id:"服务端回调客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务端回调客户端","aria-hidden":"true"}},[a._v("#")]),a._v(" 服务端回调客户端")]),a._v(" "),t("p",[a._v("服务端调用客户端的listener中的方法时，被调用的方法运行在客户端的Binder线程池中，同时服务端线程会被挂起，如果客户端方法执行比较耗时，就会导致服务端无法响应。")]),a._v(" "),t("p",[a._v("服务端应该另外开线程再调用客户端的listener中的方法。")]),a._v(" "),t("p",[a._v("客户端的listener中的方法被调用时并非运行在UI线程，因此不可直接操作UI。")]),a._v(" "),t("h2",{attrs:{id:"aidl升级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aidl升级","aria-hidden":"true"}},[a._v("#")]),a._v(" AIDL升级")]),a._v(" "),t("p",[a._v("客户端上的AIDL文件应该保持与服务端上的一致。")]),a._v(" "),t("p",[a._v("在实际开发和生产的过程中，难免会出现这样一种情况：服务端升级了，其AIDL文件被修改了。但众多客户端仍未更新，其AIDL文件仍然是旧的。此时客户端通过旧AIDL调用新的服务端时，可能会出现异常情况。不过这种异常情况是可以通过技术手段来避免的。")]),a._v(" "),t("p",[a._v("AIDL升级必须遵循以下原则，方可避免旧客户端的AIDL调用出错。")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("不可删除旧的公开函数，若实在要删除，只能通过屏蔽的方式，即保留函数，但里面是返回一个错误码或已停止使用等信息。")])]),a._v(" "),t("li",[t("p",[a._v("新增的公开函数必须要位于旧函数的后面，不能改变原来接口的声明顺序。（这是因为AIDL是按照接口的声明顺序来定义每个对外函数的"),t("code",[a._v("TRANSACTION_code")]),a._v("，客户端和服务端交互的过程中是依靠这个code来找到对应的函数，而并非通过函数签名来匹配。）")])])])])}],!1,null,null,null);e.options.__file="AIDL.md";s.default=e.exports}}]);